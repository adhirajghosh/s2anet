# Manual correction of the dataset

# Prerequisites

* Current working directory is in the project root ([parent of this folder](..))
* The tool `jq` is installed
* Both train and test dataset files are in the project root:
    * deepscores_train.json
    * deepscores_test.json
* The stats generated by the dataset statistics script ([deepscores_stats.py](deepscores_stats.py)) is in the project root:
    * stats.json
* The cli output from the dataset statistics script ([deepscores_stats.py](deepscores_stats.py), execute first with the `-c` flag, then with the `-f` flag, use `-h` flag to print usage) is available to the user.
* Your current python environment has PIL and other libraries installed (The conda environment for s2anet will suffice)
* You have have access to the dataset images (will be put in [out_debug](../out_debug) by [deepscores_stats.py](deepscores_stats.py))
* You have opened the web version of [GeoGebra](https://www.geogebra.org/classic)


# Workflow

1. Pick out the annotation id of the chosen outlier annotation (i.e. 882200)
2. Run `./tools/change_ds.sh 882200`
    * The bash script [change_ds.sh](change_ds.sh) will now first search the train database and - if not unsuccessful - then the test dataset.
    * It will display the javascript commands (open the javascript console of your browser of trust) to import the annotation data into the GeoGebra web version in bold text:
    ```
    ggbApplet.evalCommand("A=(1667, -699)")
    ggbApplet.evalCommand("C=(1683, -715)")
    ggbApplet.evalCommand("a : Line(A, xAxis)")
    ggbApplet.evalCommand("b : Line(C, xAxis)")
    ggbApplet.evalCommand("c : Line(A, yAxis)")
    ggbApplet.evalCommand("d : Line(C, yAxis)")
    ggbApplet.evalCommand("B = Intersect(a, d)")
    ggbApplet.evalCommand("D = Intersect(b, c)")
    ggbApplet.evalCommand("abbox = Polygon(A, B, C, D)")
    ggbApplet.evalCommand("E=(1683, -715)")
    ggbApplet.evalCommand("F=(1683, -699)")
    ggbApplet.evalCommand("G=(1667, -699)")
    ggbApplet.evalCommand("H=(1667, -715)")
    ggbApplet.evalCommand("obbox = Polygon(E, F, G, H)")
    ```
    Only those commands setting points to specific coordinates will have to be pasted in repeated steps.
    * `A` and `C` are opposite corners of the aligned bbox.
    * `E`, `F`, `G` and `D` are the corners of the oriented bbox.
    * Sometimes it is beneficial to manually have the corners of the oriented bbox coincide with those of the aligned bbox - especially if you are loading the same annotation in a variant image of the current source image.
        * Note that there is not always a correlation between `A` -> `E`, `B` -> `F`, etc.!
    * The script will print the unique image file name that corresponds to the selected annotation:
    ```
    Loading meta data
    filepath: "lg-162999963-aug-gutenberg1939--page-2.png"
    ```
    * The script will also display two commands for setting `I` and `J`, which denote anchor points for the image to be fixed to:
    ```
    ggbApplet.evalCommand("I = (0, -2772)")
    ggbApplet.evalCommand("J = (1960, -2772)")
    ```
3. Now load the image file corresponding to the annotation into GeoGebra: `lg-162999963-aug-gutenberg1939--page-2.png`
    1. Open the image's settings and tick the **"Fix Object"** box to prevent you form accidentally moving the image by mouse.
    2. Tick the **"Background Image"** box to display it behind the grid (This actually has a similar effect like #1)
    3. In the image settings' **"Position"** tab, set **"Corner 1"** to `I` and **"Corner 2"** to `J`.
4. Now adjust the bboxes to your needs
5. Execute the last Javascript snippet printed by the script, paste the output to the script's standard input and hit enter:
```
[ggbApplet.getXcoord('A'), -ggbApplet.getYcoord('A'), ggbApplet.getXcoord('C'), -ggbApplet.getYcoord('C')].join(', ')
```
This will set the coordinates of the **aligned bbox**
6. Execute the last Javascript snippet printed by the script, paste the output to the script's standard input and hit enter:
```
[ggbApplet.getXcoord('E'), -ggbApplet.getYcoord('E'), ggbApplet.getXcoord('F'), -ggbApplet.getYcoord('F'), ggbApplet.getXcoord('G'), -ggbApplet.getYcoord('G'), ggbApplet.getXcoord('H'), -ggbApplet.getYcoord('H')].join(', ')
```
This will set the coordinates of the **oriented bbox**.
7. Now the script will display the new coordinates and ask for confirmation. Confirm with enter and the script will write the changes back to the dataset. You can also hit Ctrl-C to abort.
8. Rinse and repeat
